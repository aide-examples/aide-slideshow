<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>System Update</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container wide">
        <a href="/" class="back-link">&larr; Back to Control Panel</a>
        <h1 style="text-align: center; margin-bottom: 20px;">System Update</h1>

        <div id="alert-container"></div>

        <div class="card">
            <h2>Version Information</h2>
            <div class="version-display">
                <span class="version-label">Current Version</span>
                <span class="version-value current" id="current-version">--</span>
            </div>
            <div class="version-display">
                <span class="version-label">Available Version</span>
                <span class="version-value" id="available-version">--</span>
            </div>
            <div class="version-display">
                <span class="version-label">Status</span>
                <span id="update-status"><span class="status-badge checking">Loading...</span></span>
            </div>
            <div class="version-display" id="last-check-row">
                <span class="version-label">Last Check</span>
                <span class="version-value" id="last-check">--</span>
            </div>
        </div>

        <div class="card">
            <h2>Actions</h2>
            <div class="actions">
                <button id="btn-check" onclick="checkForUpdates()">
                    <span class="icon">üîç</span> Check for Updates
                </button>
                <button id="btn-download" onclick="downloadUpdate()" class="secondary hidden">
                    <span class="icon">üì•</span> Download Update
                </button>
                <button id="btn-apply" onclick="applyUpdate()" class="hidden">
                    <span class="icon">üöÄ</span> Install Update & Restart
                </button>
                <button id="btn-rollback" onclick="rollback()" class="danger hidden">
                    <span class="icon">‚Ü©Ô∏è</span> Rollback to Previous Version
                </button>
                <button id="btn-enable" onclick="enableUpdates()" class="secondary hidden">
                    <span class="icon">üîì</span> Re-enable Updates
                </button>
            </div>
        </div>

        <div class="card" id="source-info">
            <h2>Update Source</h2>
            <div class="details">
                Repository: <code id="source-repo">--</code><br>
                Branch: <code id="source-branch">--</code>
            </div>
        </div>
    </div>

    <script>
        let status = null;
        let isLoading = false;

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function setLoading(buttonId, loading) {
            const btn = document.getElementById(buttonId);
            if (loading) {
                btn.disabled = true;
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> Please wait...';
            } else {
                btn.disabled = false;
                if (btn.dataset.originalText) {
                    btn.innerHTML = btn.dataset.originalText;
                }
            }
        }

        function formatDate(isoString) {
            if (!isoString) return '--';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function updateUI() {
            if (!status) return;

            // Version display
            document.getElementById('current-version').textContent = status.current_version || '--';
            document.getElementById('available-version').textContent = status.available_version || '--';
            document.getElementById('last-check').textContent = formatDate(status.last_check);

            // Available version styling
            const availableEl = document.getElementById('available-version');
            availableEl.className = 'version-value';
            if (status.version_comparison === 'update_available') {
                availableEl.classList.add('available');
            } else if (status.version_comparison === 'local_ahead') {
                availableEl.classList.add('ahead');
            }

            // Status badge
            const statusEl = document.getElementById('update-status');
            let badgeClass = 'checking';
            let badgeText = 'Unknown';

            if (status.updates_disabled) {
                badgeClass = 'disabled';
                badgeText = 'Disabled (failures)';
            } else if (status.update_state === 'staged') {
                badgeClass = 'staged';
                badgeText = 'Ready to Install';
            } else if (status.update_state === 'downloading') {
                badgeClass = 'downloading';
                badgeText = 'Downloading...';
            } else if (status.update_state === 'checking') {
                badgeClass = 'checking';
                badgeText = 'Checking...';
            } else if (status.pending_verification) {
                badgeClass = 'checking';
                badgeText = 'Verifying...';
            } else if (status.version_comparison === 'update_available') {
                badgeClass = 'update-available';
                badgeText = 'Update Available';
            } else if (status.version_comparison === 'local_ahead') {
                badgeClass = 'local-ahead';
                badgeText = 'Development Mode';
            } else if (status.version_comparison === 'up_to_date') {
                badgeClass = 'up-to-date';
                badgeText = 'Up to Date';
            }

            statusEl.innerHTML = `<span class="status-badge ${badgeClass}">${badgeText}</span>`;

            // Button visibility
            document.getElementById('btn-check').classList.remove('hidden');
            document.getElementById('btn-download').classList.toggle('hidden',
                !(status.update_available && status.update_state === 'idle'));
            document.getElementById('btn-apply').classList.toggle('hidden',
                status.update_state !== 'staged');
            document.getElementById('btn-rollback').classList.toggle('hidden',
                !status.can_rollback);
            document.getElementById('btn-enable').classList.toggle('hidden',
                !status.updates_disabled);

            // Source info
            if (status.source) {
                document.getElementById('source-repo').textContent = status.source.repo || '--';
                document.getElementById('source-branch').textContent = status.source.branch || '--';
            }
        }

        async function refreshStatus() {
            try {
                const res = await fetch('/api/update/status');
                status = await res.json();
                updateUI();
            } catch (e) {
                console.error('Status error:', e);
            }
        }

        async function checkForUpdates() {
            setLoading('btn-check', true);
            try {
                const res = await fetch('/api/update/check', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showAlert(data.message, data.update_available ? 'info' : 'success');
                } else {
                    showAlert(data.error || 'Check failed', 'error');
                }
                await refreshStatus();
            } catch (e) {
                showAlert('Network error: ' + e.message, 'error');
            }
            setLoading('btn-check', false);
        }

        async function downloadUpdate() {
            setLoading('btn-download', true);
            try {
                const res = await fetch('/api/update/download', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showAlert(data.message, 'success');
                    if (data.errors && data.errors.length > 0) {
                        showAlert('Downloaded with warnings: ' + data.errors.join(', '), 'warning');
                    }
                } else {
                    showAlert(data.error || 'Download failed', 'error');
                }
                await refreshStatus();
            } catch (e) {
                showAlert('Network error: ' + e.message, 'error');
            }
            setLoading('btn-download', false);
        }

        async function applyUpdate() {
            if (!confirm('This will install the update and restart the service. Continue?')) {
                return;
            }
            setLoading('btn-apply', true);
            try {
                const res = await fetch('/api/update/apply', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showAlert('Update applied! Service is restarting...', 'success');
                    // Wait a bit then try to reconnect
                    setTimeout(() => {
                        showAlert('Reconnecting...', 'info');
                        setTimeout(() => location.reload(), 3000);
                    }, 5000);
                } else {
                    showAlert(data.error || 'Apply failed', 'error');
                    await refreshStatus();
                }
            } catch (e) {
                showAlert('Network error (service may be restarting): ' + e.message, 'warning');
                setTimeout(() => location.reload(), 5000);
            }
            setLoading('btn-apply', false);
        }

        async function rollback() {
            if (!confirm('This will restore the previous version and restart. Continue?')) {
                return;
            }
            setLoading('btn-rollback', true);
            try {
                const res = await fetch('/api/update/rollback', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showAlert(data.message, 'success');
                    setTimeout(() => location.reload(), 5000);
                } else {
                    showAlert(data.error || 'Rollback failed', 'error');
                    await refreshStatus();
                }
            } catch (e) {
                showAlert('Network error: ' + e.message, 'error');
            }
            setLoading('btn-rollback', false);
        }

        async function enableUpdates() {
            setLoading('btn-enable', true);
            try {
                const res = await fetch('/api/update/enable', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.error || 'Failed', 'error');
                }
                await refreshStatus();
            } catch (e) {
                showAlert('Network error: ' + e.message, 'error');
            }
            setLoading('btn-enable', false);
        }

        // Initial load
        refreshStatus();

        // Auto-refresh every 10 seconds
        setInterval(refreshStatus, 10000);
    </script>
</body>
</html>
