<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AIDE - slideshow</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div id="app-header"></div>

        <div class="card">
            <div class="status-row">
                <span class="status-label" data-i18n="status"></span>
                <span class="status-value" id="status-paused">--</span>
            </div>
            <div class="status-row">
                <span class="status-label" data-i18n="monitor"></span>
                <span class="status-value" id="status-monitor">--</span>
            </div>
            <div class="status-row">
                <span class="status-label" data-i18n="images"></span>
                <span class="status-value" id="status-playlist">--</span>
            </div>
            <div class="status-row">
                <span class="status-label" data-i18n="filter"></span>
                <span class="status-value" id="status-filter">--</span>
            </div>
        </div>

        <div class="controls">
            <button onclick="api('pause')" class="secondary">
                <span class="icon">‚è∏</span> <span data-i18n="pause"></span>
            </button>
            <button onclick="api('resume')">
                <span class="icon">‚ñ∂</span> <span data-i18n="play"></span>
            </button>
            <button onclick="api('skip')" class="secondary">
                <span class="icon">‚è≠</span> <span data-i18n="skip"></span>
            </button>
            <button onclick="api('monitor/on')" class="secondary">
                <span class="icon">üì∫</span> <span data-i18n="mon_on"></span>
            </button>
            <button onclick="api('monitor/off')" class="secondary">
                <span class="icon">üåô</span> <span data-i18n="mon_off"></span>
            </button>
            <button onclick="refreshStatus()" class="secondary">
                <span class="icon">üîÑ</span> <span data-i18n="refresh"></span>
            </button>
        </div>

        <div class="speed-control">
            <label data-i18n="duration"></label>
            <div class="speed-row">
                <button onclick="changeDuration(-5)" class="secondary">‚àí5</button>
                <div class="speed-value"><span id="duration">--</span>s</div>
                <button onclick="changeDuration(5)" class="secondary">+5</button>
            </div>
        </div>

        <div class="folders">
            <h3 data-i18n="filter_folder"></h3>
            <div class="folder-list" id="folder-list">
                <button class="folder-btn" onclick="clearFilter()" data-i18n="all"></button>
            </div>
            <div class="links-row">
                <a id="file-manager-link" href="#" target="_blank" data-i18n="file_manager"></a>
                <a href="/prepare" data-i18n="image_prep"></a>
            </div>
        </div>

        <div class="card" id="version-card" style="margin-top: 20px;">
            <div class="status-row">
                <span class="status-label" data-i18n="version"></span>
                <span class="status-value" id="version-display">--</span>
            </div>
            <div class="status-row">
                <span class="status-label" data-i18n="memory"></span>
                <span class="status-value" id="memory-display" style="font-size: 0.85em; color: #888;">--</span>
            </div>
            <div class="status-row" id="update-row" style="display: none;">
                <span class="status-label" data-i18n="update"></span>
                <a href="/update" class="status-value" style="color: #60a5fa; text-decoration: none;" data-i18n="available"></a>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <a href="/update" class="version-link" style="flex: 1;" data-i18n="system_update"></a>
                <button onclick="restartServer()" class="secondary" style="padding: 8px 12px; font-size: 0.85em;" data-i18n="restart"></button>
            </div>
        </div>

        <p class="refresh-note" data-i18n="auto_refresh"></p>
    </div>

    <script src="/static/frame/js/polyglot.min.js"></script>
    <script src="/static/frame/js/i18n.js"></script>
    <script src="/static/frame/js/header-widget.js"></script>
    <script>
        let currentDuration = 35;
        let currentFilter = null;

        async function api(endpoint) {
            try {
                const res = await fetch('/' + endpoint);
                const data = await res.json();
                refreshStatus();
                return data;
            } catch (e) {
                console.error('API error:', e);
            }
        }

        async function refreshStatus() {
            try {
                const res = await fetch('/status');
                const data = await res.json();

                document.getElementById('status-paused').textContent =
                    data.paused ? i18n.t('paused') : i18n.t('playing');
                document.getElementById('status-paused').className =
                    'status-value ' + (data.paused ? 'off' : 'on');

                document.getElementById('status-monitor').textContent =
                    data.monitor_on ? i18n.t('on') : i18n.t('off');
                document.getElementById('status-monitor').className =
                    'status-value ' + (data.monitor_on ? 'on' : 'off');

                document.getElementById('status-playlist').textContent =
                    i18n.t('remaining', { count: data.playlist_size });

                currentFilter = data.filter;
                document.getElementById('status-filter').textContent =
                    data.filter || i18n.t('none');

                currentDuration = data.display_duration;
                document.getElementById('duration').textContent = currentDuration;

                // Update memory display
                if (data.memory) {
                    const mem = data.memory;
                    document.getElementById('memory-display').textContent =
                        `${mem.used_mb}/${mem.total_mb} MB (${mem.percent_used}%)`;
                }

                updateFolderButtons();
            } catch (e) {
                console.error('Status error:', e);
            }
        }

        async function loadFolders() {
            try {
                const res = await fetch('/folders');
                const data = await res.json();
                const list = document.getElementById('folder-list');
                list.innerHTML = `<button class="folder-btn" onclick="clearFilter()">${i18n.t('all')}</button>`;
                data.folders.forEach(folder => {
                    const btn = document.createElement('button');
                    btn.className = 'folder-btn';
                    btn.textContent = folder.split('/').pop();
                    btn.title = folder;
                    btn.onclick = () => setFilter(folder);
                    list.appendChild(btn);
                });
            } catch (e) {
                console.error('Folders error:', e);
            }
        }

        function updateFolderButtons() {
            const allText = i18n.t('all');
            document.querySelectorAll('.folder-btn').forEach(btn => {
                const isAll = btn.textContent === allText;
                const isActive = isAll ? !currentFilter : btn.title === currentFilter;
                btn.classList.toggle('active', isActive);
            });
        }

        async function setFilter(folder) {
            await fetch('/filter?folder=' + encodeURIComponent(folder));
            refreshStatus();
        }

        async function clearFilter() {
            await fetch('/filter/clear');
            refreshStatus();
        }

        async function changeDuration(delta) {
            currentDuration = Math.max(5, Math.min(120, currentDuration + delta));
            await fetch('/duration?seconds=' + currentDuration);
            document.getElementById('duration').textContent = currentDuration;
        }

        // Set file manager link dynamically
        document.getElementById('file-manager-link').href =
            window.location.protocol + '//' + window.location.hostname + ':8081';

        async function loadVersion() {
            try {
                const res = await fetch('/api/update/status');
                const data = await res.json();
                document.getElementById('version-display').textContent = data.current_version || '--';
                const updateRow = document.getElementById('update-row');
                if (data.update_available) {
                    updateRow.style.display = 'flex';
                } else {
                    updateRow.style.display = 'none';
                }
            } catch (e) {
                console.error('Version error:', e);
            }
        }

        async function restartServer() {
            if (confirm(i18n.t('restart_confirm'))) {
                try {
                    await fetch('/restart');
                    alert(i18n.t('restarting'));
                } catch (e) {
                    // Expected - server stops before responding
                }
            }
        }

        // Initialize
        (async () => {
            await i18n.init();
            document.title = i18n.t('app_title');
            i18n.applyToDOM();

            // Initial load
            refreshStatus();
            loadFolders();
            loadVersion();

            // Initialize header widget
            HeaderWidget.init('#app-header', { appName: i18n.t('app_title') });

            // Auto-refresh every 5 seconds
            setInterval(refreshStatus, 5000);
            setInterval(loadVersion, 30000);  // Check version every 30s
        })();
    </script>
</body>
</html>
