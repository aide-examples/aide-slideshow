<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Image Preparation</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container wide">
        <h1 style="text-align: center; margin-bottom: 20px;">Image Preparation</h1>

        <div id="message-area"></div>

        <!-- Configuration Form -->
        <div class="card" id="config-card">
            <h3>Directories</h3>
            <div class="form-group">
                <label>Input Directory</label>
                <input type="text" id="input_dir" placeholder="/path/to/source/images">
                <p class="help-text">Source folder with original images</p>
            </div>
            <div class="form-group">
                <label>Output Directory</label>
                <input type="text" id="output_dir" placeholder="/path/to/output/images">
                <p class="help-text">Destination for processed images</p>
            </div>
        </div>

        <div class="card">
            <h3>Processing Mode</h3>
            <div class="form-group">
                <label>Resize Mode</label>
                <select id="mode">
                    <option value="hybrid-stretch">Hybrid + Stretch (recommended)</option>
                    <option value="hybrid">Hybrid (crop then pad)</option>
                    <option value="crop">Crop only</option>
                    <option value="pad">Pad only</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Target Size</label>
                    <select id="target_size">
                        <option value="1920x1080">1920x1080 (Full HD)</option>
                        <option value="1280x720">1280x720 (HD)</option>
                        <option value="2560x1440">2560x1440 (QHD)</option>
                        <option value="3840x2160">3840x2160 (4K)</option>
                        <option value="1080x1920">1080x1920 (Full HD - Portrait)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Padding Color</label>
                    <select id="pad_mode">
                        <option value="average">Average (auto)</option>
                        <option value="black">Black</option>
                        <option value="white">White</option>
                        <option value="gray">Gray</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Advanced Settings</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Crop Min (0.0-1.0)</label>
                    <input type="number" id="crop_min" value="0.8" min="0" max="1" step="0.05">
                </div>
                <div class="form-group">
                    <label>Stretch Max</label>
                    <input type="number" id="stretch_max" value="0.2" min="0" max="0.5" step="0.05">
                </div>
            </div>
            <div class="form-group">
                <label>No-Stretch Limit</label>
                <input type="number" id="no_stretch_limit" value="0.4" min="0" max="1" step="0.1">
                <p class="help-text">Aspect ratio deviation beyond which no stretching occurs</p>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="skip_existing">
                <label for="skip_existing">Skip existing files</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="flatten">
                <label for="flatten">Flatten output (no subdirectories)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="show_text" checked>
                <label for="show_text">Overlay filename on images</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="dry_run">
                <label for="dry_run">Dry run (preview only, no changes)</label>
            </div>
        </div>

        <div class="card">
            <div class="btn-row">
                <button onclick="countImages()" class="secondary">Count Images</button>
                <button onclick="startJob()">Start Processing</button>
            </div>
        </div>

        <!-- Progress Display -->
        <div class="card progress-card" id="progress-card">
            <h3>Progress</h3>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>
            <div class="progress-stats">
                <div class="stat-box">
                    <div class="stat-value processed" id="stat-processed">0</div>
                    <div class="stat-label">Processed</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value exists" id="stat-exists">0</div>
                    <div class="stat-label">Skipped</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value error" id="stat-errors">0</div>
                    <div class="stat-label">Errors</div>
                </div>
            </div>
            <div class="current-file" id="current-file">Waiting...</div>
            <button onclick="cancelJob()" class="danger wide" id="cancel-btn" style="margin-top: 15px;">Cancel</button>
        </div>

        <div class="nav-links">
            <a href="/">Slideshow Control</a>
            <a id="file-manager-link" href="#" target="_blank">File Manager</a>
            <a href="/about">About</a>
        </div>
    </div>

    <script>
        let pollInterval = null;

        // Load defaults on page load
        async function loadDefaults() {
            try {
                const res = await fetch('/api/prepare/defaults');
                const data = await res.json();
                document.getElementById('input_dir').value = data.input_dir || '';
                document.getElementById('output_dir').value = data.output_dir || '';
                document.getElementById('mode').value = data.mode || 'hybrid-stretch';
                document.getElementById('pad_mode').value = data.pad_mode || 'average';
                document.getElementById('crop_min').value = data.crop_min || 0.8;
                document.getElementById('stretch_max').value = data.stretch_max || 0.2;
                document.getElementById('no_stretch_limit').value = data.no_stretch_limit || 0.4;
            } catch (e) {
                console.error('Failed to load defaults:', e);
            }

            // Check if job is already running
            checkStatus();
        }

        function showMessage(text, type = 'info') {
            const area = document.getElementById('message-area');
            area.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => area.innerHTML = '', 5000);
        }

        function getConfig() {
            return {
                input_dir: document.getElementById('input_dir').value,
                output_dir: document.getElementById('output_dir').value,
                mode: document.getElementById('mode').value,
                target_size: document.getElementById('target_size').value,
                pad_mode: document.getElementById('pad_mode').value,
                crop_min: parseFloat(document.getElementById('crop_min').value),
                stretch_max: parseFloat(document.getElementById('stretch_max').value),
                no_stretch_limit: parseFloat(document.getElementById('no_stretch_limit').value),
                skip_existing: document.getElementById('skip_existing').checked,
                flatten: document.getElementById('flatten').checked,
                show_text: document.getElementById('show_text').checked,
                dry_run: document.getElementById('dry_run').checked,
            };
        }

        async function countImages() {
            const inputDir = document.getElementById('input_dir').value;
            if (!inputDir) {
                showMessage('Please enter an input directory', 'error');
                return;
            }
            try {
                const res = await fetch('/api/prepare/count?dir=' + encodeURIComponent(inputDir));
                const data = await res.json();
                if (data.error) {
                    showMessage(data.error, 'error');
                } else {
                    showMessage(`Found ${data.count} images in ${data.directory}`, 'success');
                }
            } catch (e) {
                showMessage('Failed to count images: ' + e.message, 'error');
            }
        }

        async function startJob() {
            const config = getConfig();
            if (!config.input_dir || !config.output_dir) {
                showMessage('Please enter input and output directories', 'error');
                return;
            }

            try {
                const res = await fetch('/api/prepare/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await res.json();

                if (data.success) {
                    showMessage('Job started!', 'success');
                    document.getElementById('progress-card').classList.add('active');
                    startPolling();
                } else {
                    showMessage(data.error || 'Failed to start job', 'error');
                }
            } catch (e) {
                showMessage('Failed to start job: ' + e.message, 'error');
            }
        }

        async function cancelJob() {
            try {
                await fetch('/api/prepare/cancel');
                showMessage('Cancellation requested', 'info');
            } catch (e) {
                showMessage('Failed to cancel: ' + e.message, 'error');
            }
        }

        async function checkStatus() {
            try {
                const res = await fetch('/api/prepare/status');
                const data = await res.json();
                updateProgressUI(data);

                if (data.running) {
                    document.getElementById('progress-card').classList.add('active');
                    if (!pollInterval) startPolling();
                } else if (pollInterval) {
                    stopPolling();
                }
            } catch (e) {
                console.error('Status check failed:', e);
            }
        }

        function updateProgressUI(data) {
            const bar = document.getElementById('progress-bar');
            bar.style.width = data.percent + '%';
            bar.textContent = data.percent + '%';

            document.getElementById('stat-processed').textContent = data.counts.processed || 0;
            document.getElementById('stat-exists').textContent = data.counts.exists || 0;
            document.getElementById('stat-errors').textContent = data.counts.error || 0;

            const currentFile = document.getElementById('current-file');
            if (data.current_file) {
                currentFile.textContent = data.current_file.split('/').pop();
                currentFile.title = data.current_file;
            } else if (!data.running && data.current > 0) {
                currentFile.textContent = 'Complete!';
            } else {
                currentFile.textContent = 'Waiting...';
            }

            const cancelBtn = document.getElementById('cancel-btn');
            cancelBtn.disabled = !data.running;
            cancelBtn.textContent = data.running ? 'Cancel' : (data.cancelled ? 'Cancelled' : 'Done');

            if (!data.running && data.current > 0) {
                if (data.cancelled) {
                    showMessage('Job cancelled', 'info');
                } else if (data.error) {
                    showMessage('Job failed: ' + data.error, 'error');
                } else {
                    showMessage(`Complete! Processed: ${data.counts.processed}, Skipped: ${data.counts.exists}, Errors: ${data.counts.error}`, 'success');
                }
            }
        }

        function startPolling() {
            if (pollInterval) return;
            pollInterval = setInterval(checkStatus, 1000);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Set file manager link
        document.getElementById('file-manager-link').href =
            window.location.protocol + '//' + window.location.hostname + ':8081';

        // Initialize
        loadDefaults();
    </script>
</body>
</html>
